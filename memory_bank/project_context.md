# 📘 项目上下文文档 · 复杂金融衍生品定价工具

## 一、项目概要（Project Overview）

### 项目名称
复杂金融衍生品定价工具（Exotic Options Pricing Tool）

### 项目背景
金融衍生品市场日益复杂，exotic options（奇异期权）因其复杂的收益结构和路径依赖性，需要专业的定价工具。传统的Black-Scholes模型无法直接应用于这些复杂衍生品，需要采用数值方法如偏微分方程（PDE）和蒙特卡洛模拟（Monte Carlo, MC）进行定价。

### 目标与目的
开发一个功能完整、计算准确的金融衍生品定价工具，能够：
- 支持至少五种不同类型的exotic options定价
- 为每种期权类型提供PDE和MC两种数值计算方法
- 提供准确、可靠、可验证的定价结果
- 支持参数化配置和批量计算
- 具备良好的可扩展性，便于添加新的期权类型

### 要解决的问题
1. **定价复杂性**：Exotic options的路径依赖性和复杂收益结构需要专门的数值方法
2. **方法验证**：通过提供PDE和MC两种方法，可以交叉验证计算结果的准确性
3. **计算效率**：需要在计算精度和计算速度之间取得平衡
4. **可维护性**：代码结构需要清晰，便于添加新的期权类型和计算方法

### 整体愿景
构建一个专业级、工业化的金融衍生品定价平台，能够处理各种复杂的exotic options，为量化交易、风险管理、产品设计等金融应用提供可靠的技术支撑。

---

## 二、范围定义（Scope Definition）

### 当前范围
1. **支持的Exotic Options类型**（至少5种）：
   - Asian Options（亚式期权）：基于平均价格的期权
   - Barrier Options（障碍期权）：包含敲入/敲出条件的期权
   - Lookback Options（回望期权）：基于历史最高/最低价格的期权
   - Digital/Binary Options（数字/二元期权）：固定收益的期权
   - Compound Options（复合期权）：期权上的期权

2. **计算方法**：
   - PDE方法：有限差分法（Finite Difference Method）
   - MC方法：蒙特卡洛模拟（Monte Carlo Simulation）

3. **核心功能**：
   - 期权定价计算
   - 希腊字母（Greeks）计算
   - 结果验证与对比
   - 参数化配置

### 非本次范围
- 实时市场数据接入
- 图形用户界面（GUI）
- 数据库存储
- 分布式计算
- 风险管理模块
- 回测系统
- 其他衍生品类型（如互换、期货等）

### 约束条件
- 计算精度要求：与理论值或市场报价的误差在可接受范围内
- 性能要求：单次计算时间合理（根据期权复杂度而定）
- 代码质量：遵循最佳实践，具备良好的可读性和可维护性
- 技术栈：基于Python生态系统（NumPy, SciPy等）

---

## 三、关键实体与关系（Key Entities & Relationships）

### 核心实体

1. **Option（期权）**
   - 基础抽象类，定义期权的通用属性和接口

2. **ExoticOption（奇异期权）**
   - 继承自Option，定义exotic options的通用特征

3. **AsianOption（亚式期权）**
   - 继承自ExoticOption
   - 属性：平均价格类型（算术/几何）、观察期

4. **BarrierOption（障碍期权）**
   - 继承自ExoticOption
   - 属性：障碍价格、障碍类型（敲入/敲出）、障碍方向（向上/向下）

5. **LookbackOption（回望期权）**
   - 继承自ExoticOption
   - 属性：回望类型（固定/浮动）、观察期

6. **DigitalOption（数字期权）**
   - 继承自ExoticOption
   - 属性：固定收益金额

7. **CompoundOption（复合期权）**
   - 继承自ExoticOption
   - 属性：底层期权类型、复合期权到期日

8. **PricingMethod（定价方法）**
   - 抽象接口，定义定价方法的通用接口

9. **PDEPricing（PDE定价）**
   - 实现PricingMethod
   - 使用有限差分法求解Black-Scholes PDE

10. **MCPricing（MC定价）**
    - 实现PricingMethod
    - 使用蒙特卡洛模拟进行定价

11. **PricingEngine（定价引擎）**
    - 协调期权对象和定价方法，执行定价计算

12. **MarketData（市场数据）**
    - 包含：标的资产价格、无风险利率、波动率、到期时间等

### 实体职责

- **Option类**：定义期权的基本属性（标的价格S、执行价格K、到期时间T、无风险利率r、波动率σ、期权类型call/put）
- **ExoticOption类**：定义exotic options的通用接口和抽象方法
- **具体期权类**：实现各自特有的收益函数和边界条件
- **PricingMethod接口**：定义price()方法，返回期权价格和Greeks
- **PDEPricing类**：实现有限差分网格求解，处理边界条件和初始条件
- **MCPricing类**：实现路径模拟、收益计算和统计估计
- **PricingEngine类**：管理定价流程，支持方法切换和结果对比

### 实体关系描述
```
Option (抽象基类)
  └── ExoticOption (抽象基类)
      ├── AsianOption
      ├── BarrierOption
      ├── LookbackOption
      ├── DigitalOption
      └── CompoundOption

PricingMethod (接口)
  ├── PDEPricing
  └── MCPricing

PricingEngine
  ├── 持有 Option 实例
  ├── 持有 PricingMethod 实例
  └── 使用 MarketData 进行定价
```

---

## 四、功能模块拆解（Functional Decomposition）

### 模块列表

1. **期权类型模块（Options Module）**
   - 期权基类和具体实现
   - 收益函数计算
   - 边界条件定义

2. **PDE定价模块（PDE Pricing Module）**
   - 有限差分网格构建
   - 隐式/显式/Crank-Nicolson方法
   - 边界条件处理
   - 希腊字母计算

3. **MC定价模块（MC Pricing Module）**
   - 随机路径生成（几何布朗运动）
   - 收益函数评估
   - 统计估计（价格、标准误）
   - 方差缩减技术（可选）

4. **定价引擎模块（Pricing Engine Module）**
   - 方法选择与切换
   - 结果对比与验证
   - 批量计算支持

5. **工具模块（Utilities Module）**
   - 市场数据处理
   - 参数验证
   - 结果格式化
   - 日志记录

6. **测试模块（Testing Module）**
   - 单元测试
   - 集成测试
   - 基准测试（与理论值对比）

### 模块详情

#### 模块1：期权类型模块
- **输入**：市场数据（S, K, T, r, σ）、期权类型参数
- **输出**：期权对象实例
- **核心逻辑**：
  - 定义期权基类，包含通用属性
  - 实现各exotic option的具体类
  - 实现收益函数（payoff function）
  - 定义边界条件（boundary conditions）

#### 模块2：PDE定价模块
- **输入**：期权对象、市场数据、网格参数（时间步数、价格步数）
- **输出**：期权价格、Greeks（Delta, Gamma, Theta, Vega, Rho）
- **核心逻辑**：
  - 构建有限差分网格（时间维度×价格维度）
  - 设置初始条件（到期时的收益）
  - 设置边界条件（价格趋于0和趋于无穷时的行为）
  - 使用有限差分方法向后迭代求解
  - 计算希腊字母（通过数值微分）

#### 模块3：MC定价模块
- **输入**：期权对象、市场数据、模拟参数（路径数、时间步数）
- **输出**：期权价格、标准误、置信区间
- **核心逻辑**：
  - 生成随机数序列
  - 模拟标的资产价格路径（几何布朗运动）
  - 对每条路径计算期权收益
  - 计算平均收益并折现到当前时间
  - 计算统计误差（标准误）

#### 模块4：定价引擎模块
- **输入**：期权对象、定价方法选择、市场数据
- **输出**：定价结果、方法对比报告
- **核心逻辑**：
  - 根据用户选择调用PDE或MC方法
  - 支持同时运行两种方法进行对比
  - 结果验证与差异分析
  - 性能统计（计算时间）

#### 模块5：工具模块
- **输入**：原始数据、配置参数
- **输出**：验证后的数据、格式化结果
- **核心逻辑**：
  - 参数有效性检查
  - 数据标准化处理
  - 结果格式化输出
  - 错误处理和日志记录

#### 模块6：测试模块
- **输入**：测试用例、基准值
- **输出**：测试报告、通过/失败状态
- **核心逻辑**：
  - 单元测试：测试各个类的功能
  - 集成测试：测试完整定价流程
  - 基准测试：与已知理论值或文献值对比

### 典型用户场景

1. **场景1：单一期权定价**
   - 用户创建一个Asian Option实例
   - 选择PDE方法进行定价
   - 获取价格和Greeks结果

2. **场景2：方法对比验证**
   - 用户创建一个Barrier Option实例
   - 同时使用PDE和MC方法计算
   - 对比两种方法的结果，验证一致性

3. **场景3：批量计算**
   - 用户提供多个期权参数组合
   - 批量执行定价计算
   - 生成汇总报告

4. **场景4：敏感性分析**
   - 用户固定其他参数，改变某个参数（如波动率）
   - 计算价格变化，生成敏感性曲线

---

## 五、技术方向与关键决策（Technical Direction & Decisions）

### 客户端
暂无信息（当前为命令行工具或Python库形式）

### 服务端
暂无信息（当前为本地计算，无服务端需求）

### 模型或算法层

1. **PDE方法**：
   - 有限差分法：Crank-Nicolson方法（二阶精度，无条件稳定）
   - 网格类型：均匀网格或非均匀网格（对数空间）
   - 边界条件：线性外推或解析边界条件

2. **MC方法**：
   - 随机数生成：使用高质量随机数生成器（如Mersenne Twister）
   - 路径模拟：欧拉离散化或精确解（几何布朗运动）
   - 方差缩减：对偶变量法、控制变量法（可选）

3. **数值方法库**：
   - NumPy：数值计算基础
   - SciPy：科学计算（如稀疏矩阵求解）
   - Numba：JIT编译加速（可选）

### 数据流与架构

```
用户输入（参数）
    ↓
参数验证与市场数据准备
    ↓
创建期权对象
    ↓
选择定价方法（PDE/MC）
    ↓
执行定价计算
    ↓
结果后处理（Greeks计算、格式化）
    ↓
输出结果
```

### 已做技术决策

1. **编程语言**：Python
   - 理由：丰富的科学计算库、易于开发和维护、良好的社区支持

2. **数值方法**：
   - PDE：Crank-Nicolson方法（平衡精度和稳定性）
   - MC：标准蒙特卡洛（可扩展方差缩减技术）

3. **架构设计**：
   - 面向对象设计（继承、多态）
   - 策略模式（PricingMethod接口）
   - 工厂模式（期权对象创建）

4. **代码组织**：
   - 模块化设计，每个期权类型独立文件
   - 定价方法独立模块
   - 清晰的接口定义

### 可替代方案

1. **PDE方法替代方案**：
   - 有限元法（FEM）：更灵活，但实现复杂
   - 谱方法：高精度，但适用性有限
   - 树方法（二叉树/三叉树）：直观，但精度较低

2. **MC方法替代方案**：
   - 准蒙特卡洛（QMC）：使用低差异序列，收敛更快
   - 多级蒙特卡洛（MLMC）：自适应精度控制

3. **性能优化方案**：
   - GPU加速（CuPy, Numba CUDA）
   - 并行计算（multiprocessing, joblib）
   - C/C++扩展（Cython, pybind11）

---

## 六、交互、风格与输出约定（Interaction & Style Conventions）

### AI 输出风格
结构清晰、层级明确、工程化表达

### 表达规范
- 统一使用 Markdown 格式
- 代码使用Python语法，遵循PEP 8规范
- 数学公式使用LaTeX格式（在Markdown中）
- 必要时使用伪代码或列表说明算法流程

### 格式要求
- 严谨、有序、模块化、可迁移
- 代码注释清晰，包含文档字符串（docstring）
- 类型提示（Type Hints）增强代码可读性

### 用户特殊偏好
- 中文注释和文档
- 代码结构清晰，便于理解和扩展

---

## 七、当前进展总结（Current Status）

### 已确认事实

1. **项目需求明确**：
   - 至少支持5种exotic options
   - 每种期权提供PDE和MC两种定价方法
   - 需要计算准确、代码可维护

2. **技术选型确定**：
   - Python作为主要开发语言
   - NumPy/SciPy作为数值计算基础
   - 面向对象设计模式

3. **期权类型选定**：
   - Asian Options（亚式期权）
   - Barrier Options（障碍期权）
   - Lookback Options（回望期权）
   - Digital/Binary Options（数字/二元期权）
   - Compound Options（复合期权）

4. **计算方法确定**：
   - PDE：有限差分法（Crank-Nicolson）
   - MC：标准蒙特卡洛模拟

### 未解决问题

1. **具体实现细节**：
   - 各期权类型的收益函数具体形式
   - PDE边界条件的精确处理方式
   - MC模拟的时间步数和路径数选择

2. **性能优化策略**：
   - 是否需要并行计算
   - 是否需要GPU加速
   - 内存使用优化

3. **测试基准**：
   - 理论值或文献参考值的获取
   - 精度要求的具体数值

4. **扩展性设计**：
   - 如何设计接口便于添加新的期权类型
   - 如何支持新的定价方法

---

## 八、后续计划与风险（Next Steps & Risks）

### 待讨论主题

1. **架构设计细化**：
   - 类的具体接口设计
   - 模块间的依赖关系
   - 配置管理方式

2. **算法实现细节**：
   - PDE网格参数选择（时间步、价格步）
   - MC路径数和时间步数选择
   - 边界条件的具体实现

3. **测试策略**：
   - 单元测试覆盖范围
   - 集成测试场景
   - 基准测试用例

4. **文档和示例**：
   - API文档格式
   - 使用示例代码
   - 理论背景说明

### 潜在风险与不确定性

1. **数值稳定性风险**：
   - PDE方法在极端参数下可能不稳定
   - MC方法收敛速度可能较慢
   - **缓解措施**：参数验证、稳定性测试、自适应网格/路径数

2. **计算精度风险**：
   - 两种方法结果可能不一致
   - 与理论值存在偏差
   - **缓解措施**：方法对比验证、参数调优、基准测试

3. **性能风险**：
   - 复杂期权计算时间过长
   - 批量计算资源消耗大
   - **缓解措施**：性能优化、并行计算、缓存机制

4. **扩展性风险**：
   - 添加新期权类型可能破坏现有结构
   - 新方法集成困难
   - **缓解措施**：良好的抽象设计、接口标准化、文档完善

5. **理论正确性风险**：
   - 收益函数实现错误
   - 边界条件设置错误
   - **缓解措施**：理论验证、代码审查、测试用例

### 推荐的后续初始化 Prompt

1. **架构设计阶段**：
   ```
   基于项目上下文文档，设计复杂金融衍生品定价工具的详细架构。
   包括：类图设计、接口定义、模块划分、依赖关系。
   ```

2. **实现规划阶段**：
   ```
   基于架构设计，制定详细的实现计划。
   包括：开发顺序、优先级、技术难点、测试策略。
   ```

3. **代码实现阶段**：
   ```
   实现[具体模块名称]，遵循项目上下文文档中的设计规范。
   包括：代码实现、单元测试、文档注释。
   ```

---

## 九、术语词典（Glossary）

- **Exotic Options（奇异期权）**：具有非标准收益结构的期权，通常具有路径依赖性
- **PDE（偏微分方程）**：Partial Differential Equation，用于描述期权价格随时间和标的资产价格变化的方程
- **MC（蒙特卡洛）**：Monte Carlo，通过随机模拟进行数值计算的方法
- **有限差分法**：将连续PDE离散化为差分方程进行数值求解
- **Crank-Nicolson方法**：一种二阶精度的有限差分方法，无条件稳定
- **几何布朗运动**：用于模拟股票价格随机过程的数学模型
- **Greeks（希腊字母）**：衡量期权价格对各个参数敏感性的指标（Delta, Gamma, Theta, Vega, Rho）
- **路径依赖**：期权收益依赖于标的资产价格的历史路径，而非仅依赖于到期时的价格
- **敲入/敲出**：Barrier Options中的条件，当价格触及障碍时激活（敲入）或失效（敲出）
- **方差缩减**：MC方法中用于提高收敛速度的技术

---

## 十、附录：期权类型详细说明

### 1. Asian Options（亚式期权）
- **特点**：收益基于标的资产在观察期内的平均价格
- **类型**：算术平均/几何平均
- **路径依赖**：是（依赖整个观察期的价格）

### 2. Barrier Options（障碍期权）
- **特点**：包含障碍价格，当价格触及障碍时激活或失效
- **类型**：敲入（knock-in）/敲出（knock-out），向上/向下
- **路径依赖**：是（依赖价格是否触及障碍）

### 3. Lookback Options（回望期权）
- **特点**：收益基于观察期内的最高或最低价格
- **类型**：固定执行价格/浮动执行价格
- **路径依赖**：是（依赖整个观察期的价格）

### 4. Digital/Binary Options（数字/二元期权）
- **特点**：收益为固定金额（如果满足条件）
- **类型**：现金或无价值（cash-or-nothing）/资产或无价值（asset-or-nothing）
- **路径依赖**：通常否（仅依赖到期时价格）

### 5. Compound Options（复合期权）
- **特点**：期权上的期权，给予持有者在未来某个时点购买/出售另一个期权的权利
- **类型**：Call on Call, Put on Call, Call on Put, Put on Put
- **路径依赖**：是（依赖底层期权的价格路径）

---

**文档生成时间**：2024年
**文档版本**：v1.0
**维护者**：项目团队
