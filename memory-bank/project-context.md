# 项目上下文文档

## 项目概要

- **项目名称**: 期权定价器 (Option Pricing Engine)
- **项目背景**: 需要开发一个通用的期权定价工具，支持多种期权类型和定价方法，用于金融衍生品定价分析
- **目标与目的**: 
  - 提供统一的期权定价接口
  - 支持多种期权类型（vanilla, digital, barrier, asian 等）
  - 支持多种定价方法（蒙特卡洛方法 MC、偏微分方程方法 PDE）
  - 提供可扩展的架构，便于添加新的期权类型和定价方法
- **要解决的问题**: 
  - 不同期权类型需要不同的定价模型
  - 不同定价方法有不同的适用场景和精度
  - 需要统一的接口和模块化设计
  - 计算效率和精度的平衡
- **整体愿景**: 构建一个功能完整、易于扩展、性能优良的期权定价引擎，支持金融工程研究和实际应用

---

## 范围定义

- **当前范围**: 
  - 实现 vanilla（欧式/美式）、digital（二元）、barrier（障碍）、asian（亚式）期权类型
  - 实现蒙特卡洛（MC）和偏微分方程（PDE）两种定价方法
  - 提供统一的定价接口和参数配置
  - 基础的数值计算和随机过程模拟
  - 结果验证和误差分析
- **非本次范围**: 
  - 图形用户界面（GUI）
  - Web 服务接口
  - 实时市场数据接入
  - 复杂期权组合定价
  - 风险指标计算（Greeks）
  - 分布式计算和并行优化
- **约束条件**: 
  - 全部使用 Python 实现
  - 需要保证数值计算的稳定性和精度
  - 代码需要模块化、可测试、可维护

---

## 关键实体与关系

- **核心实体**: 
  - Option（期权）：抽象基类，定义期权的基本属性和接口
  - VanillaOption（标准期权）：继承自 Option
  - DigitalOption（二元期权）：继承自 Option
  - BarrierOption（障碍期权）：继承自 Option
  - AsianOption（亚式期权）：继承自 Option
  - PricingMethod（定价方法）：抽象基类，定义定价方法的接口
  - MonteCarloMethod（蒙特卡洛方法）：继承自 PricingMethod
  - PDEMethod（偏微分方程方法）：继承自 PricingMethod
  - MarketData（市场数据）：存储标的资产价格、波动率、利率等市场参数
  - OptionParams（期权参数）：存储期权特定参数（执行价格、到期时间、障碍价格等）
- **实体职责**: 
  - Option：定义期权的通用属性和定价接口
  - PricingMethod：实现具体的数值定价算法
  - MarketData：提供市场数据访问和验证
  - OptionParams：封装期权特定参数
- **实体关系描述**: 
  - Option 与 PricingMethod 是多对多关系（一种期权可以用多种方法定价）
  - Option 依赖 MarketData 和 OptionParams 获取定价所需数据
  - PricingMethod 接收 Option 实例和 MarketData，执行定价计算
  - 不同 Option 子类实现各自特定的定价逻辑和参数验证

---

## 功能模块拆解

### 模块列表
1. 期权类型模块（Option Types）
2. 定价方法模块（Pricing Methods）
3. 市场数据模块（Market Data）
4. 数值计算模块（Numerical Computation）
5. 随机过程模块（Stochastic Processes）
6. 结果验证模块（Validation）

### 模块详情

#### 模块1: 期权类型模块（Option Types）
- **输入**: 期权参数（执行价格、到期时间、期权类型标识等）
- **输出**: 期权对象实例，包含定价接口
- **核心逻辑**: 
  - 定义期权抽象基类
  - 实现各种期权类型的子类
  - 参数验证和默认值设置
  - 提供统一的定价接口

#### 模块2: 定价方法模块（Pricing Methods）
- **输入**: 期权对象、市场数据、方法参数（路径数、时间步数等）
- **输出**: 期权价格、置信区间（MC方法）、误差估计
- **核心逻辑**: 
  - 定义定价方法抽象基类
  - 实现蒙特卡洛方法（路径模拟、期望值计算）
  - 实现 PDE 方法（有限差分、网格求解）
  - 方法选择和参数优化

#### 模块3: 市场数据模块（Market Data）
- **输入**: 市场数据配置（标的价格、波动率、无风险利率等）
- **输出**: 标准化的市场数据对象
- **核心逻辑**: 
  - 数据验证和格式化
  - 默认值处理
  - 数据一致性检查

#### 模块4: 数值计算模块（Numerical Computation）
- **输入**: 数学表达式、计算参数
- **输出**: 数值计算结果
- **核心逻辑**: 
  - 有限差分求解器
  - 数值积分
  - 插值和外推
  - 数值稳定性处理

#### 模块5: 随机过程模块（Stochastic Processes）
- **输入**: 随机过程参数（漂移、扩散系数等）
- **输出**: 随机路径样本
- **核心逻辑**: 
  - 几何布朗运动（GBM）模拟
  - 随机数生成器管理
  - 路径生成和存储优化

#### 模块6: 结果验证模块（Validation）
- **输入**: 定价结果、参考值（解析解或已知结果）
- **输出**: 验证报告（误差、收敛性分析）
- **核心逻辑**: 
  - 与解析解对比（如有）
  - 不同方法结果对比
  - 收敛性测试
  - 误差分析

### 典型用户场景
1. 研究场景：研究人员需要快速测试不同期权类型和定价方法，比较结果
2. 教学场景：教师需要演示期权定价原理，展示不同方法的差异
3. 开发场景：开发者需要扩展新的期权类型或定价方法
4. 验证场景：需要验证定价结果的正确性和精度

---

## 技术方向与关键决策

- **客户端**: 暂无信息（纯 Python 库，无客户端）
- **服务端**: 暂无信息（本地计算，无服务端）
- **模型或算法层**: 
  - 期权定价模型：Black-Scholes 模型及其扩展
  - 数值方法：蒙特卡洛模拟、有限差分法（显式/隐式/Crank-Nicolson）
  - 随机过程：几何布朗运动（GBM）
  - 数值优化：参数校准、收敛性优化
- **数据流与架构**: 
  - 输入层：用户配置期权参数和市场数据
  - 处理层：期权对象创建 → 定价方法选择 → 数值计算执行
  - 输出层：定价结果、误差估计、验证报告
  - 架构模式：策略模式（定价方法）、工厂模式（期权创建）、模板方法模式（定价流程）
- **已做技术决策**: 
  - 使用 Python 作为唯一实现语言
  - 采用面向对象设计，便于扩展
  - 使用 NumPy 进行数值计算
  - 使用 SciPy 进行科学计算（如需要）
  - 模块化设计，每个期权类型和定价方法独立实现
- **可替代方案**: 
  - 可以考虑使用 Numba 或 Cython 加速关键计算
  - 可以考虑使用 QuantLib 作为参考或底层实现
  - 可以考虑使用 JAX 进行自动微分和 GPU 加速（未来扩展）

---

## 交互、风格与输出约定

- **AI 输出风格**: 结构清晰、层级明确、工程化表达
- **表达规范**: 统一使用 Markdown；必要时使用伪代码或列表
- **格式要求**: 严谨、有序、模块化、可迁移
- **用户特殊偏好**: 
  - 代码注释使用中文
  - 函数和类名使用英文
  - 文档字符串详细说明参数和返回值
  - 提供使用示例和测试用例

---

## 当前进展总结

- **已确认事实**: 
  - 需要支持 4 种期权类型：vanilla, digital, barrier, asian
  - 需要支持 2 种定价方法：MC 和 PDE
  - 技术栈确定为纯 Python
  - 需要模块化和可扩展的设计
- **未解决问题**: 
  - 具体使用哪些 Python 库（NumPy、SciPy 等）
  - MC 方法的路径数和 PDE 方法的网格精度如何配置
  - 是否需要支持美式期权的提前执行
  - 障碍期权的监控频率设置
  - 亚式期权的平均方式（算术平均/几何平均）
  - 数值方法的收敛性标准
  - 性能优化策略

---

## 后续计划与风险

- **待讨论主题**: 
  - 期权参数的具体定义和验证规则
  - 定价方法的默认参数设置
  - 错误处理和异常情况处理
  - 单元测试和集成测试策略
  - 性能基准和优化目标
  - 代码组织结构和文件命名规范
- **潜在风险与不确定性**: 
  - 数值稳定性：PDE 方法可能在某些参数下不稳定
  - 计算效率：MC 方法需要大量路径才能收敛，可能较慢
  - 精度平衡：不同方法在不同场景下的精度差异
  - 扩展性：未来添加新期权类型或方法的复杂度
  - 测试覆盖：如何验证定价结果的正确性（缺乏解析解的情况）
- **推荐的后续初始化 Prompt**: 
  - 使用"流程标准化"提示词生成详细的实施计划
  - 使用"智能需求理解与研发导航引擎"提示词深入分析技术选型和架构设计
  - 使用"系统架构可视化生成 Mermaid"提示词生成架构图

---

## 术语词典（扩展）

- **Vanilla Option（标准期权）**: 最基础的看涨或看跌期权，在到期日可以按执行价格买入或卖出标的资产
- **Digital Option（二元期权）**: 到期时如果满足条件支付固定金额，否则支付 0
- **Barrier Option（障碍期权）**: 期权价值依赖于标的资产价格是否触及预设的障碍价格
- **Asian Option（亚式期权）**: 期权收益依赖于标的资产在特定时间段内的平均价格
- **Monte Carlo Method（蒙特卡洛方法）**: 通过随机模拟大量路径来估计期权期望收益的数值方法
- **PDE Method（偏微分方程方法）**: 通过求解 Black-Scholes 偏微分方程来获得期权价格的数值方法
- **Black-Scholes Model**: 经典的期权定价模型，假设标的资产价格遵循几何布朗运动
